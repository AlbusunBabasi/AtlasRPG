@* AtlasRPG.Web/Views/Run/CombatResult.cshtml
   Replaces the existing file at this path.
*@
@using AtlasRPG.Application.Services
@using System.Text.Json
@model AtlasRPG.Core.Entities.Combat.CombatResult
@{
    ViewData["Title"] = Model.IsVictory ? "Victory!" : "Defeat";
    bool runIsActive = ViewBag.RunIsActive ?? false;
    Guid runId = ViewBag.RunId ?? Guid.Empty;
    bool isPve = ViewBag.IsPveTurn ?? false;
    var loot = ViewBag.Loot as LootDropResult;

    var sortedRounds = Model.Rounds.OrderBy(r => r.RoundNumber).ToList();

    // Estimate max HP: total damage received + last standing HP
    decimal estPlayerMaxHp = Model.PlayerTotalDamageTaken + (sortedRounds.Any() ? Math.Max(0, sortedRounds.Last().PlayerHpRemaining) : 0);
    decimal estOpponentMaxHp = Model.PlayerTotalDamageDealt + (sortedRounds.Any() ? Math.Max(0, sortedRounds.Last().OpponentHpRemaining) : 0);
    if (estPlayerMaxHp <= 0) estPlayerMaxHp = 100;
    if (estOpponentMaxHp <= 0) estOpponentMaxHp = 100;

    // Serialize rounds for JS replay engine
    var roundsJson = JsonSerializer.Serialize(
            sortedRounds.Select(r => new
            {
                r.RoundNumber,
                r.PlayerAction,
                r.PlayerHit,
                r.PlayerCrit,
                r.PlayerBlocked,
                PlayerDamage = (double)r.PlayerDamage,
                PlayerHpRemaining = (double)r.PlayerHpRemaining,
                r.OpponentAction,
                r.OpponentHit,
                r.OpponentCrit,
                r.OpponentBlocked,
                OpponentDamage = (double)r.OpponentDamage,
                OpponentHpRemaining = (double)r.OpponentHpRemaining,
                r.EventLog
            }),
            new JsonSerializerOptions { PropertyNamingPolicy = JsonNamingPolicy.CamelCase }
        );

    int playerHits = sortedRounds.Count(r => r.PlayerHit);
    int opponentHits = sortedRounds.Count(r => r.OpponentHit);
    string playerAcc = sortedRounds.Any() ? ((double)playerHits / sortedRounds.Count * 100).ToString("F0") + "%" : "‚Äî";
    string opponentAcc = sortedRounds.Any() ? ((double)opponentHits / sortedRounds.Count * 100).ToString("F0") + "%" : "‚Äî";
    string playerBigHit = sortedRounds.Any() ? sortedRounds.Max(r => r.PlayerDamage).ToString("F0") : "‚Äî";
    string opponentBigHit = sortedRounds.Any() ? sortedRounds.Max(r => r.OpponentDamage).ToString("F0") : "‚Äî";
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>@ViewData["Title"] ‚Äî AtlasRPG</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Rajdhani:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #09090f;
            --surf: #0e0e1a;
            --cp: #4a9eff;
            --cp0: rgba(74,158,255,.16);
            --ce: #ff4545;
            --ce0: rgba(255,69,69,.14);
            --gold: #f0c060;
            --bl: #e05070;
            --bu: #ff8830;
            --po: #50e090;
            --st: #ffe040;
            --bf: #a070ff;
            --ms: #555570;
            --bk: #60d8ff;
            --sd: #ff6020;
            --fd: 'Cinzel',serif;
            --fu: 'Rajdhani',sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: var(--bg);
            color: #c8c8d8;
            font-family: var(--fu);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* ‚îÄ‚îÄ‚îÄ COUNTDOWN ‚îÄ‚îÄ‚îÄ */
        #cdown {
            position: fixed;
            inset: 0;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: radial-gradient(ellipse at center,#1a0a2e 0%,var(--bg) 72%);
        }

            #cdown::before {
                content: '';
                position: absolute;
                inset: 0;
                background: repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(255,255,255,.01) 2px,rgba(255,255,255,.01) 4px);
                pointer-events: none;
            }

        #cnum {
            font-family: var(--fd);
            font-size: clamp(8rem,20vw,16rem);
            font-weight: 900;
            line-height: 1;
            animation: cp .85s ease-out;
        }

            #cnum.n3 {
                color: #558;
                -webkit-text-stroke: 3px #778;
                text-shadow: 0 0 80px rgba(80,80,130,.5);
            }

            #cnum.n2 {
                color: #a04020;
                -webkit-text-stroke: 3px #e06030;
                text-shadow: 0 0 80px rgba(200,80,32,.5);
            }

            #cnum.n1 {
                color: var(--ce);
                -webkit-text-stroke: 3px #ff6060;
                text-shadow: 0 0 80px rgba(255,60,60,.6);
            }

            #cnum.fi {
                font-size: clamp(3.5rem,10vw,8rem);
                color: var(--gold);
                -webkit-text-stroke: 2px #ffd060;
                text-shadow: 0 0 50px rgba(240,192,96,.9),0 0 120px rgba(240,192,96,.3);
                animation: cf .7s ease-out forwards;
            }

        #csub {
            font-size: .85rem;
            letter-spacing: 6px;
            text-transform: uppercase;
            color: rgba(200,200,220,.28);
            margin-top: .8rem;
        }

        @@keyframes cp {
            0% {
                transform: scale(1.55);
                opacity: 0
            }

            45% {
                transform: scale(.93);
                opacity: 1
            }

            100% {
                transform: scale(1);
                opacity: 1
            }
        }

        @@keyframes cf {
            0% {
                transform: scale(.6);
                opacity: 0
            }

            55% {
                transform: scale(1.1);
                opacity: 1
            }

            100% {
                transform: scale(1);
                opacity: 1
            }
        }

        /* ‚îÄ‚îÄ‚îÄ ARENA ‚îÄ‚îÄ‚îÄ */
        #arena {
            display: none;
            max-width: 1080px;
            margin: 0 auto;
            padding: 1.4rem;
        }

        /* ‚îÄ‚îÄ‚îÄ FIGHTERS BAR ‚îÄ‚îÄ‚îÄ */
        #fighters {
            display: grid;
            grid-template-columns: 1fr 44px 1fr;
            gap: .7rem;
            align-items: center;
            margin-bottom: 1.1rem;
        }

        .fp {
            background: rgba(255,255,255,.022);
            border-radius: 11px;
            padding: .9rem 1.1rem;
            border: 1px solid rgba(255,255,255,.055);
        }

            .fp.pp {
                border-color: rgba(74,158,255,.18);
            }

            .fp.ep {
                border-color: rgba(255,69,69,.16);
                text-align: right;
            }

        .fpn {
            font-family: var(--fd);
            font-size: .75rem;
            font-weight: 700;
            letter-spacing: 2.5px;
            text-transform: uppercase;
            margin-bottom: .4rem;
        }

        .fp.pp .fpn {
            color: var(--cp);
        }

        .fp.ep .fpn {
            color: var(--ce);
        }

        .hbw {
            height: 8px;
            background: rgba(255,255,255,.065);
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: .28rem;
        }

        .hbf {
            height: 100%;
            border-radius: 5px;
            transition: width .5s cubic-bezier(.4,0,.2,1);
        }

        .fp.pp .hbf {
            background: linear-gradient(90deg,#1e5ab0,var(--cp));
            box-shadow: 0 0 10px rgba(74,158,255,.3);
        }

        .fp.ep .hbf {
            background: linear-gradient(90deg,var(--ce),#ff8040);
            box-shadow: 0 0 10px rgba(255,69,69,.28);
        }

        .hpt {
            font-size: .72rem;
            font-weight: 600;
            color: rgba(185,185,210,.4);
            letter-spacing: 1px;
        }

        .sr {
            display: flex;
            flex-wrap: wrap;
            gap: 3px;
            min-height: 19px;
            margin-top: .35rem;
        }

        .fp.ep .sr {
            justify-content: flex-end;
        }

        .sc {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            padding: 1px 6px;
            border-radius: 20px;
            font-size: .62rem;
            font-weight: 700;
            letter-spacing: .5px;
            text-transform: uppercase;
            opacity: 0;
            transform: scale(.6);
            transition: all .2s cubic-bezier(.4,0,.2,1);
        }

            .sc.on {
                opacity: 1;
                transform: scale(1);
            }

        .sb {
            background: rgba(224,80,112,.17);
            border: 1px solid var(--bl);
            color: var(--bl);
        }

        .su {
            background: rgba(255,136,48,.17);
            border: 1px solid var(--bu);
            color: var(--bu);
        }

        .sp {
            background: rgba(80,224,144,.17);
            border: 1px solid var(--po);
            color: var(--po);
        }

        .ss {
            background: rgba(255,224,64,.17);
            border: 1px solid var(--st);
            color: var(--st);
        }

        .sf {
            background: rgba(160,112,255,.17);
            border: 1px solid var(--bf);
            color: var(--bf);
        }

        .sm {
            background: rgba(255,160,48,.17);
            border: 1px solid #ffa030;
            color: #ffa030;
        }

        .sa {
            background: rgba(160,160,180,.17);
            border: 1px solid #a0a0c0;
            color: #a0a0c0;
        }

        .sh {
            background: rgba(180,180,60,.17);
            border: 1px solid #c8c030;
            color: #c8c030;
        }

        .vs {
            font-family: var(--fd);
            font-size: 1.1rem;
            font-weight: 900;
            color: rgba(255,255,255,.09);
            text-align: center;
        }

        /* ‚îÄ‚îÄ‚îÄ ROUND LABEL ‚îÄ‚îÄ‚îÄ */
        #rlw {
            text-align: center;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: .6rem;
        }

        .rl {
            font-family: var(--fd);
            font-size: .8rem;
            font-weight: 600;
            letter-spacing: 4px;
            text-transform: uppercase;
            color: rgba(200,200,220,.22);
            animation: fsd .28s ease-out;
        }

            .rl.sd {
                color: var(--sd);
                text-shadow: 0 0 18px rgba(255,96,32,.45);
            }

        @@keyframes fsd {
            from {
                opacity: 0;
                transform: translateY(-5px)
            }

            to {
                opacity: 1;
                transform: none
            }
        }

        /* ‚îÄ‚îÄ‚îÄ EVENT FEED ‚îÄ‚îÄ‚îÄ */
        #feed {
            display: flex;
            flex-direction: column;
            gap: .4rem;
            min-height: 280px;
            max-height: 390px;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 0 .25rem;
            scrollbar-width: thin;
            scrollbar-color: rgba(255,255,255,.06) transparent;
        }

            #feed::-webkit-scrollbar {
                width: 3px;
            }

            #feed::-webkit-scrollbar-thumb {
                background: rgba(255,255,255,.06);
                border-radius: 2px;
            }

        .ec {
            display: flex;
            align-items: center;
            gap: .65rem;
            padding: .55rem .85rem;
            border-radius: 9px;
            border: 1px solid transparent;
            animation: es .3s cubic-bezier(.4,0,.2,1);
        }

            .ec.pe {
                background: var(--cp0);
                border-color: rgba(74,158,255,.12);
            }

            .ec.ee {
                background: var(--ce0);
                border-color: rgba(255,69,69,.1);
                flex-direction: row-reverse;
                text-align: right;
            }

            .ec.proc {
                background: rgba(240,192,96,.04);
                border-color: rgba(240,192,96,.09);
                justify-content: center;
                padding: .35rem .85rem;
            }

        @@keyframes es {
            from {
                opacity: 0;
                transform: translateX(var(--sd2,-13px))
            }

            to {
                opacity: 1;
                transform: none
            }
        }

        .ec.pe {
            --sd2: -13px;
        }

        .ec.ee {
            --sd2: 13px;
        }

        .ec.proc {
            --sd2: 0;
        }

        .ei {
            width: 28px;
            height: 28px;
            border-radius: 7px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: .9rem;
            flex-shrink: 0;
        }

        .ec.pe .ei {
            background: rgba(74,158,255,.13);
        }

        .ec.ee .ei {
            background: rgba(255,69,69,.13);
        }

        .ea {
            font-size: .8rem;
            font-weight: 600;
            color: rgba(218,218,238,.86);
        }

        .bdg {
            display: flex;
            flex-wrap: wrap;
            gap: 3px;
        }

        .ec.ee .bdg {
            justify-content: flex-end;
        }

        .b {
            padding: 1px 6px;
            border-radius: 20px;
            font-size: .6rem;
            font-weight: 700;
            letter-spacing: .5px;
            text-transform: uppercase;
        }

        .bcr {
            background: rgba(255,224,64,.17);
            color: var(--st);
            border: 1px solid rgba(255,224,64,.32);
        }

        .bbk {
            background: rgba(96,216,255,.13);
            color: var(--bk);
            border: 1px solid rgba(96,216,255,.26);
        }

        .bms {
            background: rgba(85,85,112,.18);
            color: var(--ms);
            border: 1px solid rgba(85,85,112,.28);
        }

        .bsk {
            background: rgba(160,112,255,.13);
            color: var(--bf);
            border: 1px solid rgba(160,112,255,.26);
        }

        .edm {
            font-family: var(--fd);
            font-size: 1rem;
            font-weight: 700;
            margin-left: auto;
            flex-shrink: 0;
        }

        .ec.pe .edm {
            color: var(--cp);
        }

        .ec.ee .edm {
            color: var(--ce);
            margin-left: 0;
            margin-right: auto;
        }

        .edm.cr {
            color: var(--st) !important;
            text-shadow: 0 0 10px rgba(255,224,64,.5);
        }

        .edm.ms {
            color: var(--ms) !important;
            font-size: .78rem;
        }

        .ptx {
            font-size: .72rem;
            font-weight: 600;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        /* ‚îÄ‚îÄ‚îÄ RESULT PANEL ‚îÄ‚îÄ‚îÄ */
        #rp {
            display: none;
            margin-top: 1.4rem;
            border-radius: 13px;
            overflow: hidden;
            animation: rr .6s cubic-bezier(.4,0,.2,1);
        }

        @@keyframes rr {
            from {
                opacity: 0;
                transform: translateY(26px) scale(.97)
            }

            to {
                opacity: 1;
                transform: none
            }
        }

        .rh {
            padding: 2.4rem 2rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

            .rh.v {
                background: radial-gradient(ellipse at 50% 0%,rgba(74,158,255,.12) 0%,rgba(14,14,26,.9) 65%), linear-gradient(180deg,#0c1a2e,#09090f);
                border: 1px solid rgba(74,158,255,.16);
            }

            .rh.d {
                background: radial-gradient(ellipse at 50% 0%,rgba(255,69,69,.1) 0%,rgba(14,14,26,.9) 65%), linear-gradient(180deg,#1e0909,#09090f);
                border: 1px solid rgba(255,69,69,.13);
            }

        .rt {
            font-family: var(--fd);
            font-size: clamp(2.4rem,6vw,3.8rem);
            font-weight: 900;
            letter-spacing: 8px;
            text-transform: uppercase;
            line-height: 1;
            margin-bottom: .4rem;
        }

        .rh.v .rt {
            color: var(--cp);
            text-shadow: 0 0 40px rgba(74,158,255,.5),0 0 90px rgba(74,158,255,.18);
        }

        .rh.d .rt {
            color: var(--ce);
            text-shadow: 0 0 40px rgba(255,69,69,.4), 0 0 80px rgba(255,69,69,.14);
        }

        .rsub {
            font-size: .82rem;
            letter-spacing: 4px;
            text-transform: uppercase;
            color: rgba(165,165,190,.38);
            margin-bottom: 1.4rem;
        }

        .rbs {
            display: flex;
            gap: .55rem;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 1.6rem;
        }

        .rb {
            padding: .32rem .95rem;
            border-radius: 20px;
            font-size: .72rem;
            font-weight: 700;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .rbn {
            background: rgba(255,255,255,.045);
            border: 1px solid rgba(255,255,255,.09);
            color: rgba(175,175,198,.55);
        }

        .rbs2 {
            background: rgba(255,96,32,.13);
            border: 1px solid rgba(255,96,32,.32);
            color: var(--sd);
        }

        /* ‚îÄ‚îÄ‚îÄ STATS ‚îÄ‚îÄ‚îÄ */
        .ss {
            background: rgba(255,255,255,.017);
            border-top: 1px solid rgba(255,255,255,.048);
            padding: 1.3rem 1.8rem;
        }

        .sg {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: .9rem;
        }

        .sc2 h6 {
            font-family: var(--fd);
            font-size: .62rem;
            letter-spacing: 3px;
            text-transform: uppercase;
            margin-bottom: .6rem;
        }

        .sc2.pc h6 {
            color: rgba(74,158,255,.42);
        }

        .sc2.ec h6 {
            color: rgba(255,69,69,.38);
            text-align: right;
        }

        .sc2.ec {
            text-align: right;
        }

        .sl {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: .28rem 0;
            border-bottom: 1px solid rgba(255,255,255,.032);
            font-size: .8rem;
        }

        .sc2.ec .sl {
            flex-direction: row-reverse;
        }

        .sk {
            color: rgba(148,148,172,.52);
        }

        .sv {
            font-weight: 700;
            color: rgba(218,218,238,.86);
            font-size: .88rem;
        }

        /* ‚îÄ‚îÄ‚îÄ LOOT ‚îÄ‚îÄ‚îÄ */
        .sl2 {
            background: rgba(240,192,96,.022);
            border-top: 1px solid rgba(240,192,96,.08);
            padding: 1.2rem 1.8rem;
        }

        .lh2 {
            font-family: var(--fd);
            font-size: .62rem;
            letter-spacing: 4px;
            text-transform: uppercase;
            color: rgba(240,192,96,.42);
            margin-bottom: .8rem;
        }

        .li2 {
            display: flex;
            gap: .55rem;
            flex-wrap: wrap;
        }

        .lit {
            background: rgba(255,255,255,.03);
            border: 1px solid rgba(240,192,96,.17);
            border-radius: 8px;
            padding: .6rem .85rem;
            font-size: .76rem;
        }

        .ln {
            color: var(--gold);
            font-weight: 700;
            margin-bottom: .18rem;
        }

        .lt {
            color: rgba(148,148,172,.48);
            font-size: .66rem;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        /* ‚îÄ‚îÄ‚îÄ ACTION BAR ‚îÄ‚îÄ‚îÄ */
        .ab {
            border-top: 1px solid rgba(255,255,255,.048);
            padding: 1rem 1.8rem;
            display: flex;
            gap: .55rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .ba {
            display: inline-flex;
            align-items: center;
            gap: .42rem;
            padding: .55rem 1.5rem;
            border-radius: 7px;
            font-family: var(--fu);
            font-size: .78rem;
            font-weight: 700;
            letter-spacing: 2px;
            text-transform: uppercase;
            text-decoration: none;
            border: 1px solid;
            cursor: pointer;
            transition: all .16s;
        }

        .bap {
            background: rgba(74,158,255,.13);
            border-color: rgba(74,158,255,.32);
            color: var(--cp);
        }

            .bap:hover {
                background: rgba(74,158,255,.24);
                border-color: var(--cp);
                color: #fff;
            }

        .bag {
            background: transparent;
            border-color: rgba(255,255,255,.08);
            color: rgba(165,165,190,.5);
        }

            .bag:hover {
                border-color: rgba(255,255,255,.2);
                color: rgba(218,218,238,.82);
            }

        /* ‚îÄ‚îÄ‚îÄ SD OVERLAY ‚îÄ‚îÄ‚îÄ */
        #sdov {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 200;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sdf {
            font-family: var(--fd);
            font-size: 2rem;
            font-weight: 900;
            letter-spacing: 6px;
            color: var(--sd);
            text-shadow: 0 0 50px rgba(255,96,32,.9);
            opacity: 0;
            animation: sdfa 1.3s ease-out forwards;
        }

        @@keyframes sdfa {
            0% {
                opacity: 0;
                transform: scale(.7)
            }

            25% {
                opacity: 1;
                transform: scale(1.06)
            }

            80% {
                opacity: 1;
                transform: scale(1)
            }

            100% {
                opacity: 0;
                transform: scale(1.04)
            }
        }

        @@media(max-width:580px) {
            #fighters {
                grid-template-columns: 1fr;
            }

            .vs {
                display: none;
            }

            .sg {
                grid-template-columns: 1fr;
            }

            .ec.ee {
                flex-direction: row;
                text-align: left;
            }

                .ec.ee .bdg {
                    justify-content: flex-start;
                }

                .ec.ee .edm {
                    margin-left: auto;
                    margin-right: 0;
                }

            .sc2.ec, .sc2.ec h6, .sc2.ec .sl {
                text-align: left;
                flex-direction: row;
            }
        }
    </style>
</head>
<body>

    <!-- COUNTDOWN -->
    <div id="cdown">
        <div id="cnum" class="n3">3</div>
        <div id="csub">prepare for battle</div>
    </div>

    <!-- ARENA -->
    <div id="arena">

        <div id="fighters">
            <div class="fp pp">
                <div class="fpn">‚öî You</div>
                <div class="hbw"><div class="hbf" id="php" style="width:100%"></div></div>
                <div class="hpt"><span id="pht">‚Äî</span></div>
                <div class="sr" id="psr"></div>
            </div>
            <div class="vs">VS</div>
            <div class="fp ep">
                <div class="fpn">@(Model.OpponentUsername ?? (isPve ? "üêâ Monster" : "ü§ñ Opponent")) ‚öî</div>
                <div class="hbw"><div class="hbf" id="ehp" style="width:100%"></div></div>
                <div class="hpt"><span id="eht">‚Äî</span></div>
                <div class="sr" id="esr"></div>
            </div>
        </div>

        <div id="rlw"><span class="rl" id="rlbl">Round 1</span></div>
        <div id="feed"></div>

        <!-- RESULT -->
        <div id="rp">
            <div class="rh @(Model.IsVictory ? "v" : "d")">
                <div class="rt">@(Model.IsVictory ? "Victory" : "Defeat")</div>
                <div class="rsub">@(isPve ? "PvE Encounter" : "PvP Battle")</div>
                <div class="rbs">
                    <span class="rb rbn">@Model.TotalRounds rounds</span>
                    @if (Model.WasSuddenDeath)
                    {
                        <span class="rb rbs2">‚ö° Sudden Death √ó@Model.SuddenDeathStacks</span>
                    }
                </div>
            </div>

            <div class="ss">
                <div class="sg">
                    <div class="sc2 pc">
                        <h6>Your Stats</h6>
                        <div class="sl"><span class="sk">Damage Dealt</span><span class="sv">@Model.PlayerTotalDamageDealt.ToString("F0")</span></div>
                        <div class="sl"><span class="sk">Damage Taken</span><span class="sv">@Model.PlayerTotalDamageTaken.ToString("F0")</span></div>
                        <div class="sl"><span class="sk">Critical Hits</span><span class="sv">@Model.PlayerCriticalHits</span></div>
                        <div class="sl"><span class="sk">Accuracy</span><span class="sv">@playerAcc</span></div>
                        <div class="sl"><span class="sk">Biggest Hit</span><span class="sv">@playerBigHit</span></div>
                    </div>
                    <div class="sc2 ec">
                        <h6>@(Model.OpponentUsername ?? "Opponent")</h6>
                        <div class="sl"><span class="sk">Damage Dealt</span><span class="sv">@Model.OpponentTotalDamageDealt.ToString("F0")</span></div>
                        <div class="sl"><span class="sk">Damage Taken</span><span class="sv">@Model.OpponentTotalDamageTaken.ToString("F0")</span></div>
                        <div class="sl"><span class="sk">Critical Hits</span><span class="sv">@Model.OpponentCriticalHits</span></div>
                        <div class="sl"><span class="sk">Accuracy</span><span class="sv">@opponentAcc</span></div>
                        <div class="sl"><span class="sk">Biggest Hit</span><span class="sv">@opponentBigHit</span></div>
                    </div>
                </div>
            </div>

            @if (loot?.Items?.Count > 0)
            {
                <div class="sl2">
                    <div class="lh2">üéÅ Loot Dropped</div>
                    <div class="li2">
                        @foreach (var item in loot.Items)
                        {
                            <div class="lit">
                                <div class="ln">@item.ItemName</div>
                                <div class="lt">@item.Slot</div>
                            </div>
                        }
                    </div>
                </div>
            }

            <div class="ab">
                @if (runIsActive)
                {
                    <a href="/Run/TurnHub/@runId" class="ba bap">Continue Run ‚Üí</a>
                }
                else
                {
                    <a href="/Run/Summary/@runId" class="ba bap">View Summary ‚Üí</a>
                }
                <button class="ba bag" id="rbtn">‚Ü∫ Replay</button>
            </div>
        </div>

    </div>

    <div id="sdov" style="display:none"></div>

    <script>
        // ‚îÄ‚îÄ DATA
        const ROUNDS = @Html.Raw(roundsJson);
        const PMAX = @Html.Raw(((double)estPlayerMaxHp).ToString("F2", System.Globalization.CultureInfo.InvariantCulture));
        const EMAX = @Html.Raw(((double)estOpponentMaxHp).ToString("F2", System.Globalization.CultureInfo.InvariantCulture));

        // Known skill ‚Üí status procs
        const PROCS = {
          QuickSlash:        [{ s:"Bleed",      d:2,  p:.20        }],
          WeakPoint:         [{ s:"ArmorShred", d:2,  p:1.0        }],
          CrossStrike:       [{ s:"Bleed",      d:2,  p:1.0        }],
          Sunder:            [{ s:"Bleed",      d:3,  p:.40        }],
          BleedingShot:      [{ s:"Bleed",      d:2,  p:1.0        }],
          VenomousStrike:    [{ s:"Poison",     d:3,  p:1.0        }],
          DimFlame:          [{ s:"Burn",       d:3,  p:.50        }],
          FireBall:          [{ s:"Burn",       d:3,  p:.30        }],
          Combustion:        [{ s:"Burn",       d:3,  p:1.0        }],
          AshStrike:         [{ s:"AshCloud",   d:2,  p:1.0        }],
          Paralyze:          [{ s:"Paralyze",   d:2,  p:1.0        }, { s:"Stun", d:1, p:.35 }],
          SwordDance:        [{ s:"SwordDance", d:2,  p:1.0, b:1   }],
          HuntersFocus:      [{ s:"HunterFocus",d:3,  p:1.0, b:1   }],
          ColossusStance:    [{ s:"ColossusStance",d:3,p:1.0,b:1   }],
          ShadowStep:        [{ s:"ShadowStep", d:1,  p:1.0, b:1   }],
          StaticCharge:      [{ s:"StaticCharge",d:3, p:1.0, b:1   }],
          AshArmor:          [{ s:"AshArmor",   d:3,  p:1.0, b:1   }],
          ArmorPiercingArrow:[{ s:"Mark",       d:3,  p:1.0        }],
        };

        const ICO = {
          Bleed:"ü©∏",Burn:"üî•",Poison:"‚ò†Ô∏è",Stun:"üí´",ArmorShred:"üõ°Ô∏è",
          AshCloud:"üå´Ô∏è",Mark:"üéØ",Paralyze:"‚ö°",SwordDance:"üíÉ",
          HunterFocus:"üëÅÔ∏è",ColossusStance:"üóø",ShadowStep:"üë§",
          StaticCharge:"‚ö°",AshArmor:"ü™®",
        };

        const SCLS = {
          Bleed:"sb",Burn:"su",Poison:"sp",Stun:"ss",Paralyze:"ss",
          Mark:"sm",ArmorShred:"sh",AshCloud:"sa",
          SwordDance:"sf",HunterFocus:"sf",ColossusStance:"sf",
          ShadowStep:"sf",StaticCharge:"sf",AshArmor:"sf",
        };

        const PCOL = {
          Bleed:"var(--bl)",Burn:"var(--bu)",Poison:"var(--po)",
          Stun:"var(--st)",Paralyze:"var(--st)",Mark:"#ffa030",
          ArmorShred:"#c8c030",AshCloud:"#a0a0c0",
        };

        // ‚îÄ‚îÄ STATE
        let pSt = {}, eSt = {};

        // ‚îÄ‚îÄ UTILS
        const slp = ms => new Promise(r => setTimeout(r,ms));

        function aname(n){
          if(n==="BasicAttack") return "Basic Attack";
          return n.replace(/([A-Z])/g,' $1').trim();
        }

        function aicon(n){
          const l=n.toLowerCase();
          if(n==="BasicAttack") return "‚öîÔ∏è";
          if(l.includes("stab")||l.includes("slash")) return "üó°Ô∏è";
          if(l.includes("fire")||l.includes("flame")||l.includes("burn")||l.includes("combustion")) return "üî•";
          if(l.includes("arrow")||l.includes("shot")) return "üèπ";
          if(l.includes("shadow")||l.includes("step")) return "üë§";
          if(l.includes("stance")||l.includes("colossus")) return "üõ°Ô∏è";
          if(l.includes("lightning")||l.includes("spark")||l.includes("chain")||l.includes("static")) return "‚ö°";
          if(l.includes("poison")||l.includes("venom")) return "‚ò†Ô∏è";
          if(l.includes("dance")) return "üíÉ";
          if(l.includes("focus")||l.includes("hunter")) return "üéØ";
          if(l.includes("ash")||l.includes("cloud")) return "üå´Ô∏è";
          if(l.includes("sunder")||l.includes("bleed")||l.includes("cross")) return "ü©∏";
          if(l.includes("paralyze")||l.includes("stun")) return "‚ö°";
          if(l.includes("weak")||l.includes("point")) return "üéØ";
          if(l.includes("armor")||l.includes("piercing")) return "üèπ";
          return "‚ú®";
        }

        function updHP(who, hp, max){
          document.getElementById(who+"p").style.width = Math.max(0,Math.min(100,hp/max*100))+"%";
          document.getElementById(who+"t").textContent = `${Math.max(0,Math.ceil(hp))} HP`;
        }

        function updSt(who, map){
          const row = document.getElementById(who+"sr");
          row.innerHTML="";
          for(const [s,d] of Object.entries(map)){
            if(d.r<=0) continue;
            const c=document.createElement("span");
            c.className=`sc ${SCLS[s]||"sf"}`;
            c.textContent=`${ICO[s]||"‚ú¶"} ${s}`;
            if(d.stk>1) c.textContent+=` √ó${d.stk}`;
            row.appendChild(c);
            requestAnimationFrame(()=>c.classList.add("on"));
          }
        }

        function apSt(who, s, rounds){
          const m = who==="p" ? pSt : eSt;
          const ms = s==="Burn"?3:1;
          if(m[s]){ m[s].r=rounds; if(m[s].stk<ms) m[s].stk++; }
          else     { m[s]={r:rounds,stk:1,ms}; }
          updSt(who, who==="p"?pSt:eSt);
        }

        function tickSt(who){
          const m=who==="p"?pSt:eSt;
          for(const k of Object.keys(m)){ m[k].r--; if(m[k].r<=0) delete m[k]; }
          updSt(who,m);
        }

        const feed=document.getElementById("feed");
        function addEv(html,cls){
          const d=document.createElement("div");
          d.className=`ec ${cls}`;
          d.innerHTML=html;
          feed.appendChild(d);
          feed.scrollTop=feed.scrollHeight;
        }

        // ‚îÄ‚îÄ REPLAY
        async function replay(){
          pSt={}; eSt={};
          feed.innerHTML="";
          updSt("p",{}); updSt("e",{});
          updHP("ph",PMAX,PMAX); updHP("eh",EMAX,EMAX);

          const TICK=620;
          let sdShown=false;

          for(let i=0;i<ROUNDS.length;i++){
            const r=ROUNDS[i];

            if(r.roundNumber>15 && !sdShown){
              sdShown=true;
              const ov=document.getElementById("sdov");
              ov.style.display="flex";
              ov.innerHTML='<div class="sdf">‚ö° SUDDEN DEATH ‚ö°</div>';
              await slp(1400); ov.style.display="none";
            }

            const lbl=document.getElementById("rlbl");
            lbl.className=r.roundNumber>15?"rl sd":"rl";
            lbl.textContent=""; void lbl.offsetWidth;
            lbl.textContent=r.roundNumber>15?`‚ö° Sudden Death ‚Äî Round ${r.roundNumber}`:`Round ${r.roundNumber}`;

            // ‚îÄ‚îÄ DOT tick g√∂rsel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            // EventLog formatƒ±: "pDot|eDot" (√∂rn. "23.5|0.0")
            let pDot = 0, eDot = 0;
            if (r.eventLog && r.eventLog.includes("|")) {
              const parts = r.eventLog.split("|");
              pDot = parseFloat(parts[0]) || 0;
              eDot = parseFloat(parts[1]) || 0;
            }

            // Aktif debufflarƒ± belirle (DOT label i√ßin)
            function dotLabel(map) {
              if (map["Bleed"])  return { ico:"ü©∏", label:"Bleed",  col:"var(--bl)" };
              if (map["Poison"]) return { ico:"‚ò†Ô∏è", label:"Poison", col:"var(--po)" };
              if (map["Burn"])   return { ico:"üî•", label:"Burn",   col:"var(--bu)" };
              return { ico:"üí¢", label:"DOT", col:"rgba(200,200,220,.5)" };
            }

            tickSt("p"); tickSt("e");

            // Oyuncu DOT hasar aldƒ±ysa g√∂ster
            if (pDot > 0.5) {
              const lp = dotLabel(pSt);
              addEv(`<span class="ptx" style="color:${lp.col}">${lp.ico} ${lp.label} tick ‚Äî you take <strong>${Math.ceil(pDot)}</strong> damage</span>`,"proc");
              await slp(220);
            }

            // Rakip DOT hasar aldƒ±ysa g√∂ster
            if (eDot > 0.5) {
              const le = dotLabel(eSt);
              addEv(`<span class="ptx" style="color:${le.col}">${le.ico} ${le.label} tick ‚Äî enemy takes <strong>${Math.ceil(eDot)}</strong> damage</span>`,"proc");
              await slp(220);
            }

            await slp(pDot > 0.5 || eDot > 0.5 ? 80 : 160);

            // Player action
            if(r.playerHit){
              let b="";
              if(r.playerCrit)    b+=`<span class="b bcr">Crit!</span>`;
              if(r.playerBlocked) b+=`<span class="b bbk">Blocked</span>`;
              if(r.playerAction!=="BasicAttack") b+=`<span class="b bsk">${aname(r.playerAction)}</span>`;
              addEv(`<div class="ei">${aicon(r.playerAction)}</div>
        <div style="flex:1"><div class="ea">${aname(r.playerAction)}</div><div class="bdg">${b}</div></div>
        <div class="edm${r.playerCrit?" cr":""}">${Math.ceil(r.playerDamage)}</div>`,"pe");

              const procs=PROCS[r.playerAction];
              if(procs){
                for(const proc of procs){
                  await slp(190);
                  if(proc.b){
                    apSt("p",proc.s,proc.d||2);
                    addEv(`<span class="ptx" style="color:var(--bf)">‚ú® ${ICO[proc.s]||""} ${proc.s} activated!</span>`,"proc");
                  } else {
                    apSt("e",proc.s,proc.d||2);
                    const col=PCOL[proc.s]||"var(--gold)";
                    addEv(`<span class="ptx" style="color:${col}">${ICO[proc.s]||"‚ú¶"} ${proc.s} applied!</span>`,"proc");
                  }
                }
              }
            } else {
              addEv(`<div class="ei">${aicon(r.playerAction)}</div>
        <div style="flex:1"><div class="ea">${aname(r.playerAction)}</div></div>
        <div class="edm ms">MISS</div>`,"pe");
            }

            updHP("eh",r.opponentHpRemaining,EMAX);
            await slp(TICK);
            if(r.opponentHpRemaining<=0) break;

            // Opponent action
            if(r.opponentHit){
              let ob="";
              if(r.opponentCrit)    ob+=`<span class="b bcr">Crit!</span>`;
              if(r.opponentBlocked) ob+=`<span class="b bbk">Blocked</span>`;
              addEv(`<div class="ei">${aicon(r.opponentAction)}</div>
        <div style="flex:1"><div class="ea">${aname(r.opponentAction)}</div><div class="bdg">${ob}</div></div>
        <div class="edm${r.opponentCrit?" cr":""}">${Math.ceil(r.opponentDamage)}</div>`,"ee");
            } else {
              addEv(`<div class="ei">${aicon(r.opponentAction)}</div>
        <div style="flex:1"><div class="ea">${aname(r.opponentAction)}</div></div>
        <div class="edm ms">MISS</div>`,"ee");
            }

            updHP("ph",r.playerHpRemaining,PMAX);
            await slp(TICK);
            if(r.playerHpRemaining<=0) break;
          }

          if(ROUNDS.length){
            const last=ROUNDS[ROUNDS.length-1];
            updHP("ph",Math.max(0,last.playerHpRemaining),PMAX);
            updHP("eh",Math.max(0,last.opponentHpRemaining),EMAX);
          }

          await slp(500);
          const rp=document.getElementById("rp");
          rp.style.display="block";
          rp.scrollIntoView({behavior:"smooth",block:"start"});
        }

        // ‚îÄ‚îÄ COUNTDOWN
        async function countdown(){
          const ov=document.getElementById("cdown");
          const num=document.getElementById("cnum");
          const sub=document.getElementById("csub");
          for(const [txt,cls,ms] of [["3","n3",920],["2","n2",920],["1","n1",920],["FIGHT","fi",720]]){
            num.className=cls; num.textContent=txt;
            if(cls==="fi") sub.textContent="";
            await slp(ms);
          }
          ov.style.transition="opacity .4s"; ov.style.opacity="0";
          await slp(400); ov.style.display="none";
          const ar=document.getElementById("arena");
          ar.style.cssText="display:block;opacity:0;transition:opacity .3s;";
          await slp(40); ar.style.opacity="1";
          await slp(300); await replay();
        }

        document.getElementById("rbtn")?.addEventListener("click",async()=>{
          document.getElementById("rp").style.display="none";
          await slp(150); await replay();
        });

        window.addEventListener("load",countdown);
    </script>
</body>
</html>
