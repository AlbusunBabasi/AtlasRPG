@* AtlasRPG.Web/Views/Run/TurnHub.cshtml ‚Äî FULL REPLACEMENT *@
@using AtlasRPG.Core.Enums
@using AtlasRPG.Core.Entities.Items
@using AtlasRPG.Web.Helpers
@model AtlasRPG.Web.Models.RunViews.TurnHubViewModel
@{
    ViewData["Title"] = $"Turn {Model.CurrentTurn.TurnNumber}";

    // Inventory split
    var equippedItems = Model.Inventory.Where(i => i.IsEquipped).ToList();
    var bagItems = Model.Inventory.Where(i => !i.IsEquipped).ToList();

    string RarityColor(ItemRarity r) => r switch
    {
        ItemRarity.Rare => "#e8c14a",
        ItemRarity.Magic => "#5090ff",
        _ => "#9a9a9a"
    };
    string RarityBorder(ItemRarity r) => r switch
    {
        ItemRarity.Rare => "rgba(232,193,74,.35)",
        ItemRarity.Magic => "rgba(80,144,255,.35)",
        _ => "rgba(150,150,150,.22)"
    };
    string RarityBg(ItemRarity r) => r switch
    {
        ItemRarity.Rare => "rgba(232,193,74,.06)",
        ItemRarity.Magic => "rgba(80,144,255,.06)",
        _ => "rgba(150,150,150,.04)"
    };
    string SlotIcon(ItemSlot s) => s switch
    {
        ItemSlot.Weapon => "‚öîÔ∏è",
        ItemSlot.Armor => "üõ°Ô∏è",
        ItemSlot.Belt => "üî∞",
        ItemSlot.Offhand => "üó°Ô∏è",
        _ => "üì¶"
    };
    string SlotLabel(ItemSlot s) => s switch
    {
        ItemSlot.Weapon => "Weapon",
        ItemSlot.Armor => "Armor",
        ItemSlot.Belt => "Belt",
        ItemSlot.Offhand => "Offhand",
        _ => "Item"
    };
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>@ViewData["Title"] ‚Äî AtlasRPG</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700;900&family=Rajdhani:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="~/css/turnhub.css" asp-append-version="true" />
    <style>
        
    </style>
</head>
<body>

    <!-- TOP BAR -->
    <div id="topbar">
        <div class="tb-prog">
            <div class="tb-label">Run Progress ‚Äî Turn @Model.CurrentTurn.TurnNumber / 20</div>
            <div class="prog-bar">
                <div class="prog-fill" style="width:@((Model.CurrentTurn.TurnNumber / 20.0 * 100).ToString("F0", System.Globalization.CultureInfo.InvariantCulture))%"></div>
            </div>
        </div>

        <div class="tb-badges">
            @if (Model.CurrentTurn.IsPvp)
            {
                <span class="tbdg pvp">‚öîÔ∏è PVP</span>
            }
            else
            {
                <span class="tbdg pve">üó°Ô∏è PVE</span>
            }

            <span class="tbdg gold">üí∞ @Model.Run.Gold</span>
            <span class="tbdg lives @(Model.Run.RemainingLives <= 1 ? "warn" : "")">‚ù§Ô∏è @Model.Run.RemainingLives</span>
            @if (Model.Run.PvpPoints > 0)
            {
                <span class="tbdg pvpts">üèÜ @Model.Run.PvpPoints</span>
            }
            @if (Model.Run.HasWoundDebuff)
            {
                <span class="tbdg warn">ü©∏ Wounded</span>
            }
        </div>

        <div class="tb-links">
            @if (Model.Run.AvailableSkillPoints > 0)
            {
                <a href="/Run/PassiveTree/@Model.Run.Id" class="tbl pt">üå≥ @Model.Run.AvailableSkillPoints Passive Pts</a>
            }
            else
            {
                <a href="/Run/PassiveTree/@Model.Run.Id" class="tbl pt">üå≥ Passive Tree</a>
            }
        </div>
    </div>

    <!-- MAIN HUB -->
    <div id="hub">

        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LEFT: CHARACTER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <div id="char-panel">

            <!-- Identity -->
            <div class="panel">
                <div class="char-header">
                    <div class="char-name">@Model.Run.Race.ToString() @Model.Run.Class.ToString()</div>
                    <div class="char-sub">Level @Model.Run.CurrentLevel</div>
                </div>

                @if (Model.Run.HasWoundDebuff)
                {
                    <div class="wound-warn">ü©∏ Wound Debuff ‚Äî All stats ‚àí3%</div>
                }

                @if (Model.Run.AvailableStatPoints > 0)
                {
                    <div style="padding:.3rem .85rem .5rem;">
                        <button type="button" class="alloc-badge w-100" onclick="openAllocModal()">
                            üíé @Model.Run.AvailableStatPoints Stat Points Available ‚Äî Spend Now
                        </button>
                    </div>
                }

                <!-- Vitals -->
                <div class="vitals">
                    <div class="vital hp">
                        <div class="vital-val">@Model.MaxHp.ToString("F0")</div>
                        <div class="vital-lbl">HP</div>
                    </div>
                    <div class="vital mp">
                        <div class="vital-val">@Model.MaxMana.ToString("F0")</div>
                        <div class="vital-lbl">Mana</div>
                    </div>
                    @if (Model.Ward > 0)
                    {
                        <div class="vital wd">
                            <div class="vital-val">@Model.Ward.ToString("F0")</div>
                            <div class="vital-lbl">Ward</div>
                        </div>
                    }
                    <div class="vital iv">
                        <div class="vital-val">@Model.Initiative.ToString("F0")</div>
                        <div class="vital-lbl">Initiative</div>
                    </div>
                </div>

                <!-- Raw Stats -->
                <div class="stats-section">
                    <div class="ss-title">Attributes</div>
                    @foreach (var (lbl, val) in new[] {
                    ("STR", Model.Run.Strength.ToString()),
                    ("DEX", Model.Run.Dexterity.ToString()),
                    ("AGI", Model.Run.Agility.ToString()),
                    ("INT", Model.Run.Intelligence.ToString()),
                    ("VIT", Model.Run.Vitality.ToString()),
                    ("WIS", Model.Run.Wisdom.ToString()),
                    ("LUK", Model.Run.Luck.ToString()),
                    })
                    {
                        <div class="stat-row">
                            <span class="stat-k">@lbl</span>
                            <span class="stat-v">@val</span>
                        </div>
                    }
                </div>

                <!-- Combat Stats -->
                <div class="stats-section">
                    <div class="ss-title">Combat</div>
                    @foreach (var (lbl, val, pct) in new[] {
                    ("Damage",   Model.Damage.ToString("F1"),                          false),
                    ("Armor",    Model.Armor.ToString("F1"),                           false),
                    ("Crit",     (Model.CritChance*100).ToString("F1"),                true),
                    ("Crit√ó",    Model.CritMult.ToString("F2")+"√ó",                    false),
                    ("Accuracy", (Model.Accuracy*100).ToString("F0"),                  true),
                    ("Evasion",  Model.Evasion.ToString("F0"),                         false),
                    ("Block",    Model.BlockChance>0 ? (Model.BlockChance*100).ToString("F0") : "‚Äî", Model.BlockChance>0),
                    ("Arm.Pen",  Model.ArmorPen>0 ? (Model.ArmorPen*100).ToString("F0") : "‚Äî", Model.ArmorPen>0),
                    })
                    {
                        <div class="stat-row">
                            <span class="stat-k">@lbl</span>
                            <span class="stat-v @(val != "‚Äî" ? "hi" : "")">@val@(pct && val != "‚Äî" ? "%" : "")</span>
                        </div>
                    }
                </div>

                <!-- Resistances -->
                <div class="stats-section">
                    <div class="ss-title">Resistances</div>
                    @foreach (var (lbl, val) in new[] {
                    ("Fire",      (Model.FireResist * 100).ToString("F0") + "%"),
                    ("Cold",      (Model.ColdResist * 100).ToString("F0") + "%"),
                    ("Lightning", (Model.LightResist * 100).ToString("F0") + "%"),
                    ("Chaos",     (Model.ChaosResist * 100).ToString("F0") + "%"),
                    })
                    {
                        <div class="stat-row">
                            <span class="stat-k">@lbl</span>
                            <span class="stat-v">@val</span>
                        </div>
                    }
                </div>
            </div>

        </div><!-- /left -->
        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CENTER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <div id="center-panel">

            <!-- Equipment Doll -->
            <div class="panel">
                <div class="ph"><span class="ph-title">Equipment</span></div>
                <div class="equip-grid">
                    @{
                        var slots = new[] {
                    ("Weapon",  "eslot", Model.Equipment?.Weapon?.Item),
                    ("Armor",   "eslot", Model.Equipment?.Armor?.Item),
                    ("Belt",    "eslot", Model.Equipment?.Belt?.Item),
                    ("Offhand", "eslot", Model.Equipment?.Offhand?.Item),
                    };
                    }
                    @foreach (var (slotName, _, item) in slots)
                    {
                        if (item != null)
                        {
                            var rarCls = item.Rarity switch { ItemRarity.Rare => "rr", ItemRarity.Magic => "rm", _ => "rn" };
                            var runItemId = Model.Inventory.FirstOrDefault(i => i.IsEquipped && i.Item?.Id == item.Id)?.Id;
                            <div class="eslot filled @rarCls" title="@ItemIconMapper.GetDisplayName(item)">
                                <div class="eslot-label">@slotName</div>
                                <div style="display:flex;align-items:center;gap:.45rem;margin-bottom:.2rem;">
                                    <img src="@ItemIconMapper.GetIconPath(item)"
                                         style="width:22px;height:22px;object-fit:contain;filter:brightness(0) invert(1) opacity(.6);"
                                         onerror="this.style.display='none'" alt="" />
                                    <div class="eslot-name">@ItemIconMapper.GetDisplayName(item)</div>
                                </div>
                                <div class="eslot-type">@ItemIconMapper.GetSubTypeName(item) ¬∑ iLv @item.ItemLevel</div>
                                @foreach (var aff in item.Affixes.Take(3))
                                {
                                    <div class="eslot-affix">@aff.AffixDefinition?.DisplayName @ItemIconMapper.FormatAffixValue(aff)</div>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="eslot">
                                <div class="eslot-label">@slotName</div>
                                <div class="eslot-empty">Empty slot</div>
                            </div>
                        }
                    }
                </div>
            </div>

            <!-- Skill Selection -->
            <div class="panel" id="skill-panel">
                <div class="ph">
                    <span class="ph-title">Active Skill</span>
                    @if (Model.Equipment?.Weapon?.Item != null)
                    {
                        <span class="skill-wtype">@Model.Equipment.Weapon.Item.WeaponType</span>
                    }
                </div>
                <div class="pb">
                    @if (Model.AvailableSkills.Any() && Model.Equipment?.Weapon != null)
                    {
                        <form asp-controller="Run" asp-action="StartCombat" method="post" id="combatForm">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="TurnId" value="@Model.CurrentTurn.Id" />

                            <div class="skills-grid" id="skillsGrid">
                                @foreach (var skill in Model.AvailableSkills)
                                {
                                    bool isSelected = Model.LastSelectedSkillId.HasValue
                                    ? Model.LastSelectedSkillId.Value == skill.Id
                                    : Model.AvailableSkills.First().Id == skill.Id;

                                    string skillIcon = skill.WeaponType.ToString() switch
                                    {
                                        "Bow" => "üèπ",
                                        "Wand" => "‚ö°",
                                        "Staff" => "üî•",
                                        "TwoHandSword" => "‚öîÔ∏è",
                                        "Dagger" => "üó°Ô∏è",
                                        _ => "‚öîÔ∏è"
                                    };

                                    <label class="skill-opt @(isSelected ? "selected" : "")" onclick="selectSkill(this)">
                                        <input type="radio" name="SelectedSkillId" value="@skill.Id" @(isSelected ? "checked" : "") />
                                        <div class="skill-icon">@skillIcon</div>
                                        <div class="skill-info">
                                            <div class="skill-name">@skill.DisplayName</div>
                                            <div class="skill-badges">
                                                <span class="sk-b sk-mult">@skill.Multiplier.ToString("F2")√ó</span>
                                                @if (skill.ManaCost > 0)
                                                {
                                                    <span class="sk-b sk-mana">@skill.ManaCost mana</span>
                                                }
                                                @if (skill.Cooldown > 0)
                                                {
                                                    <span class="sk-b sk-cd">CD @skill.Cooldown</span>
                                                }
                                            </div>
                                            <div class="skill-desc">@skill.Description</div>
                                        </div>
                                    </label>
                                }
                            </div>

                            <!-- Fight Button -->
                            <div class="fight-wrap" style="padding:.7rem 0 0;">
                                <button type="submit" class="btn-fight @(Model.CurrentTurn.IsPvp ? "pvp" : "pve")">
                                    @(Model.CurrentTurn.IsPvp ? "‚öîÔ∏è  Start PVP Battle" : "üó°Ô∏è  Start Encounter")
                                </button>
                            </div>
                        </form>
                    }
                    else if (Model.Equipment?.Weapon == null)
                    {
                        <div style="padding:.5rem;text-align:center;color:rgba(200,200,220,.3);font-size:.8rem;">
                            No weapon equipped ‚Äî equip a weapon to unlock skills
                        </div>
                        <div class="fight-wrap" style="padding:.7rem 0 0;">
                            <button class="btn-fight @(Model.CurrentTurn.IsPvp ? "pvp" : "pve")" disabled>
                                Equip a Weapon First
                            </button>
                        </div>
                    }
                    else
                    {
                        <div style="padding:.5rem;text-align:center;color:rgba(200,200,220,.3);font-size:.8rem;">
                            No skills available for current weapon at your level
                        </div>
                    }
                </div>
            </div>

        </div><!-- /center -->
        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RIGHT: TABS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <div class="panel" style="display:flex;flex-direction:column;height:fit-content;max-height:calc(100vh - 68px);overflow:hidden;">

            @if (TempData["Success"] != null)
            {
                <div class="notif ok">‚úì @TempData["Success"]</div>
            }
            @if (TempData["Error"] != null)
            {
                <div class="notif err">‚úï @TempData["Error"]</div>
            }

            <div class="tab-bar">
                <button class="tab-btn active" onclick="switchTab('inv',this)">Inventory</button>
                <button class="tab-btn" onclick="switchTab('shop',this)">Shop</button>
            </div>

            <!-- INVENTORY TAB -->
            <div class="tab-content active" id="tab-inv">

                @if (Model.Run.AvailableSkillPoints > 0)
                {
                    <div class="passives-cta">
                        <span>üå≥ @Model.Run.AvailableSkillPoints passive point@(Model.Run.AvailableSkillPoints > 1 ? "s" : "") available</span>
                        <a href="/Run/PassiveTree/@Model.Run.Id">Spend</a>
                    </div>
                }

                @if (equippedItems.Any())
                {
                    <div class="inv-section"><span class="inv-sec-lbl">Equipped</span></div>
                    @foreach (var ri in equippedItems)
                    {
                        if (ri.Item == null) continue;
                        var rarCls = ri.Item.Rarity switch { ItemRarity.Rare => "rr", ItemRarity.Magic => "rm", _ => "rn" };
                        var sellP = (ri.Item.Rarity switch { ItemRarity.Rare => "30", ItemRarity.Magic => "15", _ => "8" });
                        <div class="item-card @rarCls">
                            <div class="ic-img-wrap">
                                <img src="@ItemIconMapper.GetIconPath(ri.Item)"
                                     class="ic-img"
                                     alt="@ItemIconMapper.GetDisplayName(ri.Item)"
                                     onerror="this.classList.add('broken')" />
                                <span class="ic-fallback">@ItemIconMapper.GetFallbackEmoji(ri.Item)</span>
                            </div>
                            <div class="ic-body">
                                <div class="ic-header">
                                    <div class="ic-name">@ItemIconMapper.GetDisplayName(ri.Item)</div>
                                    <div class="ic-slot">@ri.Item.Slot</div>
                                </div>
                                <div class="ic-meta">@ItemIconMapper.GetSubTypeName(ri.Item) ¬∑ iLv @ri.Item.ItemLevel ¬∑ @ItemIconMapper.GetRarityLabel(ri.Item.Rarity)</div>
                                @{
                                    var impl1 = ItemIconMapper.GetImplicitStats(ri.Item);
                                }
                                @if (!string.IsNullOrEmpty(impl1))
                                {
                                    <div class="ic-implicit">@impl1</div>
                                }
                                @if (ri.Item.Affixes.Any())
                                {
                                    <div class="ic-affixes">
                                        @foreach (var aff in ri.Item.Affixes)
                                        {
                                            <div class="ic-aff">@aff.AffixDefinition?.DisplayName @ItemIconMapper.FormatAffixValue(aff)</div>
                                        }
                                    </div>
                                }
                                <div class="ic-actions">
                                    <span class="ic-equipped-badge">‚úì Equipped</span>
                                    <form asp-controller="Inventory" asp-action="Unequip" method="post" style="display:inline">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="runId" value="@Model.Run.Id" />
                                        <input type="hidden" name="runItemId" value="@ri.Id" />
                                        <button type="submit" class="ic-btn unequip">Unequip</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    }
                }

                @if (bagItems.Any())
                {
                    <div class="inv-section"><span class="inv-sec-lbl">Backpack (@bagItems.Count)</span></div>
                    @foreach (var ri in bagItems)
                    {
                        if (ri.Item == null) continue;
                        var rarCls = ri.Item.Rarity switch { ItemRarity.Rare => "rr", ItemRarity.Magic => "rm", _ => "rn" };
                        int sellPri = ri.Item.Rarity switch { ItemRarity.Rare => 30, ItemRarity.Magic => 15, _ => 8 };
                        sellPri += ri.Item.ItemLevel * 2;
                        <div class="item-card @rarCls">
                            <div class="ic-img-wrap">
                                <img src="@ItemIconMapper.GetIconPath(ri.Item)"
                                     class="ic-img"
                                     alt="@ItemIconMapper.GetDisplayName(ri.Item)"
                                     onerror="this.classList.add('broken')" />
                                <span class="ic-fallback">@ItemIconMapper.GetFallbackEmoji(ri.Item)</span>
                            </div>
                            <div class="ic-body">
                                <div class="ic-header">
                                    <div class="ic-name">@ItemIconMapper.GetDisplayName(ri.Item)</div>
                                    <div class="ic-slot">@ri.Item.Slot</div>
                                </div>
                                <div class="ic-meta">@ItemIconMapper.GetSubTypeName(ri.Item) ¬∑ iLv @ri.Item.ItemLevel ¬∑ @ItemIconMapper.GetRarityLabel(ri.Item.Rarity)</div>
                                @{
                                    var impl2 = ItemIconMapper.GetImplicitStats(ri.Item);
                                }
                                @if (!string.IsNullOrEmpty(impl2))
                                {
                                    <div class="ic-implicit">@impl2</div>
                                }
                                @if (ri.Item.Affixes.Any())
                                {
                                    <div class="ic-affixes">
                                        @foreach (var aff in ri.Item.Affixes)
                                        {
                                            <div class="ic-aff">@aff.AffixDefinition?.DisplayName @ItemIconMapper.FormatAffixValue(aff)</div>
                                        }
                                    </div>
                                }
                                <div class="ic-actions">
                                    <form asp-controller="Inventory" asp-action="Equip" method="post" style="display:inline">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="runId" value="@Model.Run.Id" />
                                        <input type="hidden" name="runItemId" value="@ri.Id" />
                                        <button type="submit" class="ic-btn equip">Equip</button>
                                    </form>
                                    <form asp-controller="Shop" asp-action="Sell" method="post" style="display:inline">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="runId" value="@Model.Run.Id" />
                                        <input type="hidden" name="runItemId" value="@ri.Id" />
                                        <button type="submit" class="ic-btn sell">Sell @sellPri g</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    }
                }

                @if (!equippedItems.Any() && !bagItems.Any())
                {
                    <div style="padding:2rem;text-align:center;color:rgba(180,180,200,.28);font-size:.8rem;">
                        No items ‚Äî visit the Shop tab
                    </div>
                }
            </div><!-- /tab-inv -->
            <!-- SHOP TAB -->
            <div class="tab-content" id="tab-shop">
                @{
                    var shopItems = ViewBag.ShopItems as List<AtlasRPG.Core.Entities.Items.Item>;
                    var shopPrices = ViewBag.ShopPrices as Dictionary<Guid, int>;
                }
                @if (shopItems != null && shopItems.Any())
                {
                    @foreach (var item in shopItems)
                    {
                        var rarCls = item.Rarity switch { ItemRarity.Rare => "rr", ItemRarity.Magic => "rm", _ => "rn" };
                        int price = shopPrices != null && shopPrices.TryGetValue(item.Id, out var p) ? p : 20;
                        bool canAfford = Model.Run.Gold >= price;

                        <div class="item-card @rarCls">
                            <div class="ic-img-wrap">
                                <img src="@ItemIconMapper.GetIconPath(item)"
                                     class="ic-img"
                                     alt="@ItemIconMapper.GetDisplayName(item)"
                                     onerror="this.classList.add('broken')" />
                                <span class="ic-fallback">@ItemIconMapper.GetFallbackEmoji(item)</span>
                            </div>
                            <div class="ic-body">
                                <div class="ic-header">
                                    <div class="ic-name">@ItemIconMapper.GetDisplayName(item)</div>
                                    <div class="ic-slot">@item.Slot</div>
                                </div>
                                <div class="ic-meta">@ItemIconMapper.GetSubTypeName(item) ¬∑ iLv @item.ItemLevel ¬∑ @ItemIconMapper.GetRarityLabel(item.Rarity)</div>
                                @{
                                    var impl3 = ItemIconMapper.GetImplicitStats(item);
                                }
                                @if (!string.IsNullOrEmpty(impl3))
                                {
                                    <div class="ic-implicit">@impl3</div>
                                }
                                @if (item.Affixes.Any())
                                {
                                    <div class="ic-affixes">
                                        @foreach (var aff in item.Affixes)
                                        {
                                            <div class="ic-aff">@aff.AffixDefinition?.DisplayName @ItemIconMapper.FormatAffixValue(aff)</div>
                                        }
                                    </div>
                                }
                                <div class="ic-actions">
                                    <form asp-controller="Shop" asp-action="Buy" method="post" style="display:inline">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="runId" value="@Model.Run.Id" />
                                        <input type="hidden" name="itemId" value="@item.Id" />
                                        <button type="submit" class="ic-btn buy" @(!canAfford ? "disabled" : "")
                                                title="@(!canAfford ? "Not enough gold" : "")">
                                            Buy @price g
                                        </button>
                                    </form>
                                    <span class="ic-price">@price üí∞</span>
                                </div>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div style="padding:2rem;text-align:center;color:rgba(180,180,200,.28);font-size:.8rem;">
                        Loading shop items...
                    </div>
                }

                <div class="upgrade-link-wrap">
                    <a asp-controller="Shop" asp-action="Upgrade" asp-route-runId="@Model.Run.Id">
                        ‚¨ÜÔ∏è Upgrade Items
                    </a>
                </div>
            </div><!-- /tab-shop -->

        </div><!-- /right panel -->

    </div><!-- /hub -->
    <!-- STAT ALLOC MODAL -->
    @if (Model.Run.AvailableStatPoints > 0)
    {
        <div class="modal-ov" id="allocModal" style="display:none">
            <div class="modal-box">
                <button class="modal-close" onclick="closeAllocModal()">‚úï</button>
                <div class="modal-title">üíé Allocate Stat Points</div>
                <div class="alloc-pts">Points remaining: <span id="remPts">@Model.Run.AvailableStatPoints</span></div>

                <form asp-controller="Run" asp-action="AllocateStats" method="post" id="allocForm">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="RunId" value="@Model.Run.Id" />
                    <input type="hidden" name="AvailablePoints" value="@Model.Run.AvailableStatPoints" />

                    <div class="alloc-grid">
                        @foreach (var (nm, field, cur, hint) in new[] {
                    ("üí™ Strength",     "StrengthToAdd",     Model.Run.Strength,     "Phys damage & melee"),
                    ("üéØ Dexterity",    "DexterityToAdd",    Model.Run.Dexterity,    "Ranged dmg & accuracy"),
                    ("‚ö° Agility",      "AgilityToAdd",      Model.Run.Agility,      "Initiative & evasion"),
                    ("üß† Intelligence", "IntelligenceToAdd", Model.Run.Intelligence, "Spell damage & mana"),
                    ("‚ù§Ô∏è Vitality",     "VitalityToAdd",     Model.Run.Vitality,     "HP & survivability"),
                    ("üåä Wisdom",       "WisdomToAdd",       Model.Run.Wisdom,       "Mana regen & ward"),
                    ("üçÄ Luck",         "LuckToAdd",         Model.Run.Luck,         "Crit & drops"),
                    })
                        {
                            <div class="alloc-row">
                                <div class="alloc-name">@nm</div>
                                <div class="alloc-current">Current: @cur ¬∑ <span style="color:rgba(200,200,220,.45);font-size:.63rem;">@hint</span></div>
                                <div class="alloc-ctrl">
                                    <button type="button" class="alloc-btn" onclick="adjustStat('@field',-1)" id="btn_dec_@field">‚àí</button>
                                    <div class="alloc-num" id="val_@field">0</div>
                                    <input type="hidden" name="@field" id="inp_@field" value="0" />
                                    <button type="button" class="alloc-btn" onclick="adjustStat('@field',1)" id="btn_inc_@field">+</button>
                                </div>
                            </div>
                        }
                    </div>

                    <button type="submit" class="btn-alloc-submit" id="allocSubmit" disabled>
                        Confirm Allocation
                    </button>
                </form>
            </div>
        </div>
    }

    <script>
        // ‚îÄ‚îÄ TABS
        function switchTab(id, btn) {
          document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          document.getElementById('tab-' + id).classList.add('active');
          btn.classList.add('active');
        }

        // ‚îÄ‚îÄ SKILL SELECT
        function selectSkill(lbl) {
          document.querySelectorAll('.skill-opt').forEach(o => o.classList.remove('selected'));
          lbl.classList.add('selected');
          lbl.querySelector('input').checked = true;
        }

        // ‚îÄ‚îÄ STAT ALLOC MODAL
        const MAX_PTS = @Model.Run.AvailableStatPoints;
        const FIELDS  = ['StrengthToAdd','DexterityToAdd','AgilityToAdd','IntelligenceToAdd','VitalityToAdd','WisdomToAdd','LuckToAdd'];
        let allocs = {};
        FIELDS.forEach(f => allocs[f] = 0);

        function used() { return FIELDS.reduce((s,f) => s + allocs[f], 0); }

        function adjustStat(field, delta) {
          const cur = allocs[field];
          const nxt = cur + delta;
          if (nxt < 0) return;
          if (delta > 0 && used() >= MAX_PTS) return;
          allocs[field] = nxt;
          document.getElementById('val_' + field).textContent = nxt;
          document.getElementById('inp_' + field).value = nxt;
          const rem = MAX_PTS - used();
          document.getElementById('remPts').textContent = rem;
          document.getElementById('allocSubmit').disabled = used() === 0;
          // disable inc buttons if no pts left
          FIELDS.forEach(f => {
            const btn = document.getElementById('btn_inc_' + f);
            if (btn) btn.disabled = rem === 0;
          });
        }

        function openAllocModal() {
          FIELDS.forEach(f => {
            allocs[f] = 0;
            document.getElementById('val_' + f).textContent = '0';
            document.getElementById('inp_' + f).value = '0';
          });
          document.getElementById('remPts').textContent = MAX_PTS;
          document.getElementById('allocSubmit').disabled = true;
          document.getElementById('allocModal').style.display = 'flex';
        }

        function closeAllocModal() {
          document.getElementById('allocModal').style.display = 'none';
        }

        // close on overlay click
        document.getElementById('allocModal')?.addEventListener('click', function(e) {
          if (e.target === this) closeAllocModal();
        });

        // Auto-open shop tab if TempData has error and shop was last action
        @if (TempData["ShopAction"] != null)
        {
            <text>
              document.querySelector('[onclick="switchTab(\'shop\',this)"]')?.click();
            </text>
        }
    </script>

</body>
</html>
