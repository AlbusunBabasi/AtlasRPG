@* AtlasRPG.Web/Views/Shop/Upgrade.cshtml *@
@using AtlasRPG.Core.Entities.Runs
@using AtlasRPG.Core.Entities.Items
@using AtlasRPG.Core.Enums
@using AtlasRPG.Web.Helpers
@model List<RunItem>
@{
    ViewData["Title"] = "Upgrade Items";
    var run = ViewBag.Run as Run;
}

<div style="background:#060610;min-height:100vh;padding:0;color:#c8c8d8;font-family:'Rajdhani',sans-serif;">

<!-- TOP BAR -->
<div style="background:rgba(6,6,16,.95);border-bottom:1px solid rgba(255,255,255,.07);
            padding:.6rem 1.4rem;display:flex;align-items:center;gap:1rem;flex-wrap:wrap;
            position:sticky;top:0;z-index:50;">
    <div style="font-family:'Cinzel',serif;font-size:.75rem;font-weight:700;
                letter-spacing:4px;text-transform:uppercase;color:rgba(220,200,100,.6);">
        ⬆️ Upgrade Workshop
    </div>
    <div style="padding:.3rem .9rem;border-radius:20px;background:rgba(240,192,96,.1);
                border:1px solid rgba(240,192,96,.25);color:#f0c060;font-size:.75rem;font-weight:700;">
        💰 @run?.Gold Gold
    </div>
    <div style="margin-left:auto;display:flex;gap:.6rem;">
        <a asp-controller="Shop" asp-action="Index" asp-route-runId="@run?.Id"
           style="padding:.3rem .85rem;border-radius:7px;border:1px solid rgba(74,158,255,.25);
                  color:rgba(74,158,255,.7);background:rgba(74,158,255,.06);text-decoration:none;
                  font-size:.7rem;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;">
            🛒 Shop
        </a>
        <a asp-controller="Run" asp-action="TurnHub" asp-route-id="@run?.Id"
           style="padding:.3rem .85rem;border-radius:7px;border:1px solid rgba(74,158,255,.25);
                  color:rgba(74,158,255,.7);background:rgba(74,158,255,.06);text-decoration:none;
                  font-size:.7rem;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;">
            ← Turn Hub
        </a>
    </div>
</div>

<!-- ALERTS -->
    @if (TempData["Success"] != null)
    {
        <div style="margin:1rem 1.4rem;padding:.5rem 1rem;background:rgba(60,200,100,.1);
                border:1px solid rgba(60,200,100,.22);border-radius:8px;color:#70e090;font-size:.8rem;">
            ✓ @TempData["Success"]
        </div>
    }
    @if (TempData["Error"] != null)
    {
        <div style="margin:1rem 1.4rem;padding:.5rem 1rem;background:rgba(255,80,80,.1);
                border:1px solid rgba(255,80,80,.22);border-radius:8px;color:#ff8080;font-size:.8rem;">
            ✕ @TempData["Error"]
        </div>
    }

<div style="padding:1.2rem 1.4rem;">
    <!-- LEGEND -->
    <div style="display:flex;gap:1rem;margin-bottom:1.2rem;flex-wrap:wrap;">
        <div style="font-size:.72rem;color:rgba(180,180,200,.4);">
            ⚪ <span style="color:rgba(180,180,200,.6);">Normal → Magic:</span>
            <span style="color:#f0c060;">35 + 6×ilvl gold</span>
        </div>
        <div style="font-size:.72rem;color:rgba(180,180,200,.4);">
            🔵 <span style="color:rgba(180,180,200,.6);">Magic → Rare:</span>
            <span style="color:#f0c060;">70 + 10×ilvl gold</span>
        </div>
        <div style="font-size:.72rem;color:rgba(180,180,200,.4);">
            🔄 <span style="color:rgba(180,180,200,.6);">Reroll Affixes:</span>
            <span style="color:#f0c060;">Normal: 6+2×ilvl · Magic: 10+3×ilvl · Rare: 18+5×ilvl</span>
        </div>
    </div>

        @if (!Model.Any())
        {
            <div style="text-align:center;padding:4rem;color:rgba(180,180,200,.3);font-size:.9rem;">
                📦 No items in bag to upgrade.<br>
                <small>Equipped items can't be upgraded. Unequip first.</small>
            </div>
        }
        else
        {
            <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:.8rem;">
                @foreach (var ri in Model)
                {
                    var item = ri.Item;
                    int ilvl = item.ItemLevel;

                    int upgradeCost = item.Rarity switch
                    {
                        ItemRarity.Normal => 35 + 6 * ilvl,
                        ItemRarity.Magic => 70 + 10 * ilvl,
                        _ => 0
                    };
                    int rerollCost = item.Rarity switch
                    {
                        ItemRarity.Normal => 6 + 2 * ilvl,
                        ItemRarity.Magic => 10 + 3 * ilvl,
                        ItemRarity.Rare => 18 + 5 * ilvl,
                        _ => 10
                    };

                    string rarityClass = item.Rarity switch
                    {
                        ItemRarity.Rare => "border-color:rgba(240,192,96,.6);background:rgba(240,192,96,.04);",
                        ItemRarity.Magic => "border-color:rgba(74,158,255,.5);background:rgba(74,158,255,.04);",
                        _ => "border-color:rgba(150,150,170,.25);background:rgba(150,150,170,.03);",
                    };
                    string rarityLabel = item.Rarity switch
                    {
                        ItemRarity.Rare => "🟡 Rare",
                        ItemRarity.Magic => "🔵 Magic",
                        _ => "⚪ Normal",
                    };

                    bool canUpgrade = item.Rarity != ItemRarity.Rare
                                     && run!.Gold >= upgradeCost;
                    bool canAfford = run!.Gold >= upgradeCost;
                    bool canReroll = run!.Gold >= rerollCost;
                    string implicitStats = ItemIconMapper.GetImplicitStats(item);

                        <div style="border:1.5px solid;border-radius:10px;padding:.9rem;@rarityClass">

                            <!-- Header -->
                            <div style="display:flex;align-items:center;gap:.6rem;margin-bottom:.6rem;">
                                <img src="@ItemIconMapper.GetIconPath(item)"
                                     style="width:38px;height:38px;filter:brightness(0) invert(1) opacity(.75);"
                                     onerror="this.style.display='none'">
                                <div style="flex:1;">
                                    <div style="font-family:'Cinzel',serif;font-size:.78rem;font-weight:700;
                                        color:#d8daf0;">@ItemIconMapper.GetDisplayName(item)</div>
                                    <div style="font-size:.62rem;color:rgba(150,150,170,.5);
                                        letter-spacing:1.5px;text-transform:uppercase;">
                                    @ItemIconMapper.GetSubTypeName(item) · iLv @item.ItemLevel · @rarityLabel
                                    </div>
                                </div>
                            </div>

                            <!-- Implicit Stats -->
                        @if (!string.IsNullOrEmpty(implicitStats))
                        {
                                    <div style="font-size:.67rem;color:rgba(200,210,180,.6);
                                    margin-bottom:.4rem;padding:.2rem .4rem;
                                    background:rgba(255,255,255,.03);border-radius:4px;">
                                @implicitStats
                                    </div>
                        }

                            <!-- Affixes -->
                        @if (item.Affixes.Any())
                        {
                                    <div style="margin-bottom:.5rem;">
                                @foreach (var aff in item.Affixes)
                                {
                                                <div style="font-size:.7rem;color:rgba(160,190,230,.7);
                                            padding:.1rem 0;">
                                                    + @aff.AffixDefinition?.DisplayName
                                        @ItemIconMapper.FormatAffixValue(aff)
                                                    <span style="font-size:.58rem;color:rgba(120,120,140,.4);
                                                 margin-left:.3rem;">T@aff.Tier</span>
                                                </div>
                                }
                                    </div>
                        }

                            <!-- Actions -->
                            <div style="display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.6rem;
                                padding-top:.6rem;border-top:1px solid rgba(255,255,255,.06);">

                            @* UPGRADE *@
                            @if (item.Rarity != ItemRarity.Rare)
                            {
                                        <form asp-controller="Shop" asp-action="Upgrade" method="post"
                                              style="display:inline">
                                    @Html.AntiForgeryToken()
                                            <input type="hidden" name="runId"    value="@run!.Id" />
                                            <input type="hidden" name="runItemId" value="@ri.Id"  />
                                            <button type="submit"
                                    @(canAfford ? "" : "disabled")
                                                    style="padding:.25rem .7rem;border-radius:6px;font-size:.68rem;
                                               font-weight:700;letter-spacing:1px;cursor:@(canAfford?"pointer":"not-allowed");
                                               border:1px solid @(canAfford?"rgba(240,192,96,.4)":"rgba(100,100,120,.2)");
                                               color:@(canAfford?"#f0c060":"rgba(120,120,140,.4)");
                                               background:@(canAfford?"rgba(240,192,96,.1)":"transparent");">
                                                ⬆️ Upgrade · @upgradeCost g
                                        @if (!canAfford)
                                        {
                                            <text> (need @(upgradeCost - run!.Gold)g)</text>
                                        }
                                            </button>
                                        </form>
                            }
                            else
                            {
                                        <span style="font-size:.68rem;color:rgba(120,120,140,.4);
                                         padding:.25rem .7rem;">🏆 Max Rarity</span>
                            }

                            @* REROLL *@
                                <form asp-controller="Shop" asp-action="Reroll" method="post"
                                      style="display:inline">
                                @Html.AntiForgeryToken()
                                    <input type="hidden" name="runId"    value="@run!.Id" />
                                    <input type="hidden" name="runItemId" value="@ri.Id"  />
                                    <button type="submit"
                                @(canReroll ? "" : "disabled")
                                            style="padding:.25rem .7rem;border-radius:6px;font-size:.68rem;
                                           font-weight:700;letter-spacing:1px;cursor:@(canReroll?"pointer":"not-allowed");
                                           border:1px solid @(canReroll?"rgba(100,180,255,.35)":"rgba(100,100,120,.2)");
                                           color:@(canReroll?"#7ab8ff":"rgba(120,120,140,.4)");
                                           background:@(canReroll?"rgba(100,180,255,.08)":"transparent");">
                                        🔄 Reroll · @rerollCost g
                                    </button>
                                </form>

                            </div>
                        </div>
                }
            </div>
        }
</div>

</div>
